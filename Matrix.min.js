"use strict";function _typeof(a){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_typeof(a)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.Matrix=void 0;var _Mixin=require("curvature/base/Mixin"),_EventTargetMixin=require("curvature/mixin/EventTargetMixin");function _slicedToArray(a,b){return _arrayWithHoles(a)||_iterableToArrayLimit(a,b)||_unsupportedIterableToArray(a,b)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(a,b){if(a){if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);return"Object"===c&&a.constructor&&(c=a.constructor.name),"Map"===c||"Set"===c?Array.from(a):"Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c)?_arrayLikeToArray(a,b):void 0}}function _arrayLikeToArray(a,b){(null==b||b>a.length)&&(b=a.length);for(var c=0,d=Array(b);c<b;c++)d[c]=a[c];return d}function _iterableToArrayLimit(a,b){var c=null==a?null:"undefined"!=typeof Symbol&&a[Symbol.iterator]||a["@@iterator"];if(null!=c){var d,e,f=[],g=!0,h=!1;try{for(c=c.call(a);!(g=(d=c.next()).done)&&(f.push(d.value),!(b&&f.length===b));g=!0);}catch(a){h=!0,e=a}finally{try{g||null==c["return"]||c["return"]()}finally{if(h)throw e}}return f}}function _arrayWithHoles(a){if(Array.isArray(a))return a}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}function _inherits(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function");a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),b&&_setPrototypeOf(a,b)}function _setPrototypeOf(a,b){return _setPrototypeOf=Object.setPrototypeOf||function(a,b){return a.__proto__=b,a},_setPrototypeOf(a,b)}function _createSuper(a){var b=_isNativeReflectConstruct();return function(){var c,d=_getPrototypeOf(a);if(b){var e=_getPrototypeOf(this).constructor;c=Reflect.construct(d,arguments,e)}else c=d.apply(this,arguments);return _possibleConstructorReturn(this,c)}}function _possibleConstructorReturn(a,b){return b&&("object"===_typeof(b)||"function"==typeof b)?b:_assertThisInitialized(a)}function _assertThisInitialized(a){if(void 0===a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return a}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(a){return!1}}function _getPrototypeOf(a){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(a){return a.__proto__||Object.getPrototypeOf(a)},_getPrototypeOf(a)}var Matrix=function(a){function b(){var a;return _classCallCheck(this,b),a=c.call(this),a.baseUrl="https://matrix.org/_matrix",a.clientUrl="".concat(a.baseUrl,"/client/r0"),a.mediaUrl="".concat(a.baseUrl,"/media/r0"),a.mediaCache=new Map,a.profileCache=new Map,a}_inherits(b,a);var c=_createSuper(b);return _createClass(b,[{key:"initSso",value:function initSso(a){var b=this,c=window.open("".concat(this.clientUrl,"/").concat("login/sso/redirect?redirectUrl="+a));window.addEventListener("message",function ssoListener(a){if(a.origin===location.origin){var c=JSON.parse(a.data);"s.sso.complete"!==c.type||(sessionStorage.setItem("matrix:access-token",JSON.stringify(c.data)),b.dispatchEvent(new CustomEvent("login")))}})}},{key:"completeSso",value:function completeSso(a){var b={type:"m.login.token",token:a,txn_id:(1/Math.random()).toString(36)};fetch("".concat(this.clientUrl,"/").concat("login"),{method:"POST",body:JSON.stringify(b)}).then(function(a){return a.json()}).then(function(a){window.opener.postMessage(JSON.stringify({type:"s.sso.complete",data:a}),location.origin),window.close()})}},{key:"getGuestToken",value:function getGuestToken(){var a=sessionStorage.getItem("matrix:access-token")||"false",b=JSON.parse(a);if(b&&b.isGuest)return Promise.resolve(b);var c=fetch("".concat(this.clientUrl,"/register?kind=guest"),{method:"POST",body:"{}"}).then(function(a){return a.json()});return c.then(function(a){a.isGuest=!0,sessionStorage.setItem("matrix:access-token",JSON.stringify(a))}),c}},{key:"getToken",value:function getToken(){var a=sessionStorage.getItem("matrix:access-token")||"false",b=JSON.parse(a);return b?Promise.resolve(b):matrix.getGuestToken()}},{key:"listenForServerEvents",value:function listenForServerEvents(){var a=this,b=JSON.parse(sessionStorage.getItem("matrix:access-token")||"false");if(!b)return Promise.reject("No access token found.");var c="".concat(this.clientUrl,"/events?access_token=").concat(b.access_token);fetch(c).then(function(a){return a.json()}).then(function(b){return a.streamServerEvents(b)})}},{key:"listenForRoomEvents",value:function listenForRoomEvents(a,b){var c=this,d=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"";if(!(b&&b.cancelled)){var e=JSON.parse(sessionStorage.getItem("matrix:access-token")||"false");if(!e)return Promise.reject("No access token found.");var f="".concat(this.clientUrl,"/events?room_id=").concat(a,"&access_token=").concat(e.access_token,"&from=").concat(d);return b=b||{cancelled:!1},fetch(f).then(function(a){return a.json()}).then(function(d){return c.streamServerEvents(d,a,b)}),b}}},{key:"getUserProfile",value:function getUserProfile(a){if(this.profileCache.has(a,void 0))return this.profileCache.get(a,void 0);var b=fetch("".concat(this.clientUrl,"/profile/").concat(a)).then(function(a){return a.json()});return this.profileCache.set(a,b),b}},{key:"getUserData",value:function getUserData(a){var b=JSON.parse(sessionStorage.getItem("matrix:access-token")||"false");return b?fetch("".concat(this.clientUrl,"/user/").concat(b.user_id,"/account_data/").concat(a,"?access_token=").concat(b.access_token)).then(function(a){return a.json()}):Promise.reject("No access token found.")}},{key:"putUserData",value:function putUserData(a,b){var c=JSON.parse(sessionStorage.getItem("matrix:access-token")||"false");if(c){var d="".concat(this.clientUrl,"/user/").concat(c.user_id,"/account_data/").concat(a,"?access_token=").concat(c.access_token);return fetch(d,{method:"PUT",body:b}).then(function(a){if(!a.ok){var b=new Error("HTTP status code: "+a.status);throw b.status=a.status,b.response=a,b}return a}).then(function(a){return a.json()})}}},{key:"getMediaUrl",value:function getMediaUrl(a){var b=new URL(a);return"".concat(this.mediaUrl,"/download/").concat(b.pathname.substr(2))}},{key:"getMedia",value:function getMedia(a){if(this.mediaCache.has(a))return this.mediaCache.get(a);var b=fetch(this.getMediaUrl(a)).then(function(a){return Promise.all([a.arrayBuffer(),a.headers.get("Content-type")])}).then(function(a){var b=_slicedToArray(a,2),c=b[0],d=b[1];return URL.createObjectURL(new Blob([c],{type:d}))});return this.mediaCache.set(a,b),b}},{key:"postMedia",value:function postMedia(a){var b=sessionStorage.getItem("matrix:access-token")||"false",c=JSON.parse(b);if(c){var d="".concat(this.mediaUrl,"/upload?access_token=").concat(c.access_token),e=new Headers({"Content-Type":a.type});return fetch(d,{method:"POST",headers:e,body:a}).then(function(a){return a.json()})}}},{key:"putEvent",value:function putEvent(a,b,c){var d=sessionStorage.getItem("matrix:access-token")||"false",e=JSON.parse(d);if(e){var f="".concat(this.clientUrl,"/rooms/").concat(a,"/send/").concat(b,"/").concat(Math.random().toString(36),"?access_token=").concat(e.access_token),g=new Headers({"Content-Type":c.type}),h={method:"PUT",headers:g,body:JSON.stringify(c)};return fetch(f,h).then(function(a){return a.json()})}}},{key:"sync",value:function sync(){var a=sessionStorage.getItem("matrix:access-token")||"false",b=JSON.parse(a);if(!b)return Promise.resolve();var c="".concat(this.clientUrl,"/sync?full_state=true&access_token=").concat(b.access_token);return fetch(c).then(function(a){return a.json()})}},{key:"getRoomState",value:function getRoomState(a){var b=sessionStorage.getItem("matrix:access-token")||"false",c=JSON.parse(b);if(!c)return Promise.resolve();var d="".concat(this.clientUrl,"/rooms/").concat(a,"/state?access_token=").concat(c.access_token);return fetch(d).then(function(a){return a.json()})}},{key:"syncRoom",value:function syncRoom(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"",c=JSON.parse(sessionStorage.getItem("matrix:access-token")||"false");if(!c)return Promise.reject("No access token found.");var d="".concat(this.clientUrl,"/rooms/").concat(a,"/messages?dir=b&room_id=").concat(a,"&access_token=").concat(c.access_token,"&from=").concat(b);return fetch(d).then(function(a){return a.json()})}},{key:"syncRoomHistory",value:function syncRoomHistory(a,b){var c=this,d=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;this.syncRoom(a,b).then(function(b){return b.chunk&&d&&b.chunk.forEach(d),b.chunk.length&&c.syncRoomHistory(a,b.end,d)})}},{key:"streamServerEvents",value:function streamServerEvents(a,b,c){var d=this;c&&c.cancelled||(b?this.listenForRoomEvents(b,c,a.end):this.listenForServerEvents(),a.chunk&&a.chunk.forEach(function(a){var b=new MatrixEvent;a.event_id||(a.event_id="local:"+(1/Math.random()).toString(36)),b.consume(a),d.dispatchEvent(new CustomEvent("matrix-event",{detail:b})),d.dispatchEvent(new CustomEvent(b.type,{detail:b}))}))}},{key:"getCurrentUserId",value:function getCurrentUserId(){var a=sessionStorage.getItem("matrix:access-token")||"false",b=JSON.parse(a);return b?b.user_id:void 0}},{key:"createRoom",value:function createRoom(a,b,c){var d=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{},e=JSON.stringify({name:a,topic:b,visibility:c,initial_state:d}),f=JSON.parse(sessionStorage.getItem("matrix:access-token")||"false");if(!f)return Promise.resolve();var g="".concat(this.clientUrl,"/createRoom?access_token=").concat(f.access_token);return fetch(g,{body:e,method:"POST"}).then(function(a){return a.json()})}},{key:"joinRoom",value:function joinRoom(a){var b=JSON.parse(sessionStorage.getItem("matrix:access-token")||"false");return b?void fetch("".concat(this.clientUrl,"/rooms/").concat(a,"/join?access_token=").concat(b.access_token),{method:"POST"}).then(function(a){return a.json()}):Promise.reject("No access token found.")}}]),b}(_Mixin.Mixin["with"](_EventTargetMixin.EventTargetMixin));exports.Matrix=Matrix;
